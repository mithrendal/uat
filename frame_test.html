<html>
<head>
<script>
var stop = false;
var frameCount = 0;
var fps, fpsInterval, startTime, now, then, elapsed;
let box_count=100;


function startAnimating(fps) {
    fpsInterval = 1000 / fps;
    then = Date.now();
    startTime = then;
    frameCount = 0;
}


_animate = function() {

    // stop
    if (stop) {
        return;
    }

    // request another frame

    requestAnimationFrame(_animate);

    // calc elapsed time since last loop

    now = Date.now();
    elapsed = now - then;
  
    // if enough time has elapsed, draw the next frame

    if (elapsed > fpsInterval) {

        // Get ready for next frame by setting then=now, but...
        // Also, adjust for fpsInterval not being multiple of 16.67
        then = now - (elapsed % fpsInterval);


        // TESTING...Report #seconds since start and achieved fps.
        var sinceStart = now - startTime;
        var currentFps = Math.round(1000 / (sinceStart / ++frameCount) * 100) / 100;
        var results = document.getElementById('results');
        results.innerHTML=("Elapsed time= " + Math.round(sinceStart / 1000 * 100) / 100 + " secs @ " + currentFps + " fps.");


        // draw stuff here
        let canvas = document.getElementById("canvas");
        const ctx = canvas.getContext('2d');
        
        for(let b=0;b<box_count;b++)
        {
            ctx.fillStyle = `rgb(${b%255}, 0, ${100+sinceStart%100})`;
            let posx= b%200;
            ctx.fillRect(posx, posx, 50, 50);
        }
    }
}


startAnimating(50);
_animate();

</script>

</head>
<body>


<h3>requestAnimationFrame FPS problem on z3</h3>
<p id="results">Results:</p>
<canvas id="canvas" width=300 height=200></canvas>
<br>
boxes to draw<input type="number" value="100" onchange="box_count=this.value;startAnimating(50)"> 
<button type="button" onclick="stop=true">stop</button>
<button type="button" onclick="if(stop==true) {stop=false;startAnimating(50);_animate();}">start</button>
</body>
</html>